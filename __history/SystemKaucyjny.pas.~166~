unit SystemKaucyjny;

interface

uses
  // Windows & VCL
  Winapi.Windows, Winapi.Messages,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  Vcl.Grids, Vcl.DBGrids, Vcl.StdCtrls,

  // System
  System.SysUtils, System.Variants, System.Classes, System.IOUtils,
  Data.DB,

  // FireDAC
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error,
  FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.VCLUI.Wait,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  FireDAC.Phys.SQLite, FireDAC.Phys.SQLiteDef,
  FireDAC.Stan.ExprFuncs,

  // FastReport
  frxClass, frxDBSet,

  // Twoje jednostki
  SzczeegolyProduktuUnit,
  FrakcjeDRS,
  UstawieniaProgramu, FireDAC.Comp.ScriptCommands, FireDAC.Stan.Util,
  FireDAC.Comp.Script;


type
  TSystemKaucyjnyForm = class(TForm)
    FDConnection1: TFDConnection;
    FDQuery1: TFDQuery;
    DataSource1: TDataSource;
    DBGrid1: TDBGrid;
    ButtonFrakcjeDRS: TButton;
    Button1: TButton;
    ButtonRaport: TButton;
    frxReport2: TfrxReport;
    frxDBItems: TfrxDBDataset;
    FDScript1: TFDScript;
    procedure FormCreate(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure Button1Click(Sender: TObject);
    procedure ButtonFrakcjeDRSClick(Sender: TObject);
    procedure ButtonRaportClick(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
  private
  end;

var
  SystemKaucyjnyForm: TSystemKaucyjnyForm;

implementation

{$R *.dfm}

procedure TSystemKaucyjnyForm.FormCreate(Sender: TObject);
var
  Cnt: Integer;
begin
  KeyPreview := True;

  // ===== Połączenie z SQLite =====
  try
    FDConnection1.Connected := True;
  except
    on E: Exception do
    begin
      MessageDlg('Błąd połączenia z bazą danych: ' + E.Message,
        mtError, [mbOK], 0);
      Exit;
    end;
  end;

  FDScript1.ValidateAll();
  FDScript1.ExecuteAll();

  // ===== Query =====
  FDQuery1.Close;
  FDQuery1.SQL.Clear;
  FDQuery1.SQL.Text := 'SELECT * FROM Produkty';
  FDQuery1.Open;

  // ===== DBGrid =====
  DataSource1.DataSet := FDQuery1;
  DBGrid1.Options := DBGrid1.Options + [dgRowSelect] - [dgEditing];

end;

procedure TSystemKaucyjnyForm.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #27 then
    Close;
end;

procedure TSystemKaucyjnyForm.ButtonRaportClick(Sender: TObject);
begin
FDQuery1.Close;
FDQuery1.SQL.Text := 'SELECT * FROM Produkty';
FDQuery1.Open;
frxDBItems.DataSet := FDQuery1;
frxDBItems.UserName := 'Produkty';

  frxReport2.ShowReport;
end;

procedure TSystemKaucyjnyForm.Button1Click(Sender: TObject);
begin
  UstawieniaProgramuForm.Show;
end;

procedure TSystemKaucyjnyForm.ButtonFrakcjeDRSClick(Sender: TObject);
begin
  FrakcjeDRSForm.Show;
end;

procedure TSystemKaucyjnyForm.DBGrid1DblClick(Sender: TObject);
var
  ProduktID, ProduktIlosc: Integer;
  ProduktNazwa: string;
begin
  if DataSource1.DataSet.IsEmpty then Exit;

  ProduktID := DataSource1.DataSet.FieldByName('id').AsInteger;
  ProduktNazwa := DataSource1.DataSet.FieldByName('nazwa').AsString;
  ProduktIlosc := DataSource1.DataSet.FieldByName('ilosc').AsInteger;

  if Assigned(ProduktForm) then
  begin
    ProduktForm.UstawDane(ProduktID, ProduktNazwa, ProduktIlosc);
    ProduktForm.ShowModal;
  end;
end;

end.