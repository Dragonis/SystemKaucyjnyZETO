unit SystemKaucyjny;

interface

uses
  // Windows & VCL
  Winapi.Windows, Winapi.Messages,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  Vcl.Grids, Vcl.DBGrids, Vcl.StdCtrls,

  // System
  System.SysUtils, System.Variants, System.Classes, System.IOUtils,
  Data.DB,

  // FireDAC
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error,
  FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.VCLUI.Wait,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  FireDAC.Phys.SQLite, FireDAC.Phys.SQLiteDef,
  FireDAC.Stan.ExprFuncs,

  // FastReport
  frxClass, frxDBSet,

  // Twoje jednostki
  SzczeegolyProduktuUnit,
  FrakcjeDRS,
  UstawieniaProgramu, FireDAC.Comp.ScriptCommands, FireDAC.Stan.Util,
  FireDAC.Comp.Script;


type
  TSystemKaucyjnyForm = class(TForm)
    FDConnection1: TFDConnection;
    FDQuery1: TFDQuery;
    DataSource1: TDataSource;
    DBGrid1: TDBGrid;
    ButtonFrakcjeDRS: TButton;
    Button1: TButton;
    ButtonRaport: TButton;
    frxReport2: TfrxReport;
    frxDBItems: TfrxDBDataset;
    FDScript1: TFDScript;
    Label1: TLabel;
    Label2: TLabel;
    Memo1: TMemo;
    Button2: TButton;
    DBGrid2: TDBGrid;
    Paragon: TLabel;
    procedure FormCreate(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure Button1Click(Sender: TObject);
    procedure ButtonFrakcjeDRSClick(Sender: TObject);
    procedure ButtonRaportClick(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private
    procedure LosujProdukty;
  end;

var
  SystemKaucyjnyForm: TSystemKaucyjnyForm;

implementation

{$R *.dfm}

procedure TSystemKaucyjnyForm.FormCreate(Sender: TObject);
var
  Cnt: Integer;
  SQLPath: string;
begin
  Randomize; // dla losowania
  KeyPreview := True;

  // ===== Połączenie z SQLite =====
  try
    FDConnection1.Connected := True;
  except
    on E: Exception do
    begin
      MessageDlg('Błąd połączenia z bazą danych: ' + E.Message,
        mtError, [mbOK], 0);
      Exit;
    end;
  end;

  // ===== Tabela =====
  SQLPath := TPath.Combine(
    ExtractFilePath(ParamStr(0))+'\sql\',
    'init.sql'
  );

  if not FileExists(SQLPath) then
    raise Exception.Create('Brak pliku init.sql');

  FDScript1.Connection := FDConnection1;
  FDScript1.SQLScripts.Clear;
  FDScript1.SQLScripts.Add.SQL.LoadFromFile(SQLPath);
  FDScript1.ExecuteAll;

  FDQuery1.SQL.Text := 'SELECT * FROM Produkty';
  FDQuery1.Open;

  // ===== Dane testowe =====
  Cnt := FDConnection1.ExecSQLScalar(
    'SELECT COUNT(*) FROM Produkty'
  );

  // ===== DBGrid =====
  DataSource1.DataSet := FDQuery1;
  DBGrid1.Options := DBGrid1.Options + [dgRowSelect] - [dgEditing];
end;

procedure TSystemKaucyjnyForm.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #27 then
    Close;
end;

procedure TSystemKaucyjnyForm.ButtonRaportClick(Sender: TObject);
begin
  FDQuery1.Close;

  FDQuery1.SQL.Text :=
    'SELECT ' +
    'id AS id, ' +
    'Nazwa AS name, ' +
    'Ilosc AS quantity, ' +
    'Marza_Proc AS margin, ' +
    'Cena_Ew AS cost_price, ' +
    'Cena_Det AS retail_price ' +
    'FROM Produkty';

  FDQuery1.Open;
  frxDBItems.DataSet := FDQuery1;
  frxDBItems.UserName := 'Items';

  frxReport2.ShowReport;
end;

procedure TSystemKaucyjnyForm.LosujProdukty;
var
  iloscProduktu: Integer;
  cenaProduktu, suma: Double;
begin
  // 1. Losowanie produktów z bazy
  FDQuery1.Close;
  FDQuery1.SQL.Text := 'SELECT Nazwa, Cena_Det FROM Produkty ORDER BY RANDOM() LIMIT :Limit';
  FDQuery1.ParamByName('Limit').AsInteger := Random(5) + 1; // 1..5 produktów
  FDQuery1.Open;

  // ===== Memo1 =====
  Memo1.Lines.Clear;
  suma := 0;

  while not FDQuery1.Eof do
  begin
    iloscProduktu := Random(10) + 1;
    cenaProduktu := FDQuery1.FieldByName('Cena_Det').AsFloat;

    Memo1.Lines.Add(
      FDQuery1.FieldByName('Nazwa').AsString + ' - ' +
      IntToStr(iloscProduktu) + ' szt. - ' +
      FormatFloat('0.00', cenaProduktu) + ' zł'
    );

    suma := suma + (iloscProduktu * cenaProduktu);
    FDQuery1.Next;
  end;

  Memo1.Lines.Add('-------------------------');
  Memo1.Lines.Add('SUMA: ' + FormatFloat('0.00', suma) + ' zł');

  // ===== DBGrid2 =====
  // Przygotowujemy ClientDataSet dla DBGrid2
  if not Assigned(CDSLosoweProdukty) then
  begin
    CDSLosoweProdukty := TClientDataSet.Create(Self);
    DSLosoweProdukty.DataSet := CDSLosoweProdukty;
    DBGrid2.DataSource := DSLosoweProdukty;

    // Tworzymy kolumny
    CDSLosoweProdukty.FieldDefs.Add('Nazwa', ftString, 50);
    CDSLosoweProdukty.FieldDefs.Add('Ilosc', ftInteger);
    CDSLosoweProdukty.FieldDefs.Add('Cena', ftFloat);
    CDSLosoweProdukty.CreateDataSet;
  end
  else
    CDSLosoweProdukty.EmptyDataSet;

  // Wypełniamy dane w ClientDataSet
  FDQuery1.First;
  while not FDQuery1.Eof do
  begin
    iloscProduktu := Random(10) + 1;
    cenaProduktu := FDQuery1.FieldByName('Cena_Det').AsFloat;

    CDSLosoweProdukty.Append;
    CDSLosoweProdukty.FieldByName('Nazwa').AsString := FDQuery1.FieldByName('Nazwa').AsString;
    CDSLosoweProdukty.FieldByName('Ilosc').AsInteger := iloscProduktu;
    CDSLosoweProdukty.FieldByName('Cena').AsFloat := cenaProduktu;
    CDSLosoweProdukty.Post;

    FDQuery1.Next;
  end;
end;

procedure TSystemKaucyjnyForm.Button1Click(Sender: TObject);
begin
  UstawieniaProgramuForm.Show;
end;

procedure TSystemKaucyjnyForm.Button2Click(Sender: TObject);
begin
  LosujProdukty;
end;

procedure TSystemKaucyjnyForm.ButtonFrakcjeDRSClick(Sender: TObject);
begin
  FrakcjeDRSForm.Show;
end;

procedure TSystemKaucyjnyForm.DBGrid1DblClick(Sender: TObject);
var
  ProduktID, ProduktIlosc: Integer;
  ProduktNazwa: string;
begin
  if DataSource1.DataSet.IsEmpty then Exit;

  ProduktID := DataSource1.DataSet.FieldByName('id').AsInteger;
  ProduktNazwa := DataSource1.DataSet.FieldByName('nazwa').AsString;
  ProduktIlosc := DataSource1.DataSet.FieldByName('ilosc').AsInteger;

  if Assigned(ProduktForm) then
  begin
    ProduktForm.UstawDane(ProduktID, ProduktNazwa, ProduktIlosc);
    ProduktForm.ShowModal;
  end;
end;

end.

