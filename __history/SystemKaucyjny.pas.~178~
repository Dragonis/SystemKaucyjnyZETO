unit SystemKaucyjny;

interface

uses
  // Windows & VCL
  Winapi.Windows, Winapi.Messages,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  Vcl.Grids, Vcl.DBGrids, Vcl.StdCtrls,

  // System
  System.SysUtils, System.Variants, System.Classes, System.IOUtils,
  Data.DB,

  // FireDAC
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error,
  FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.VCLUI.Wait,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  FireDAC.Phys.SQLite, FireDAC.Phys.SQLiteDef,
  FireDAC.Stan.ExprFuncs,

  // FastReport
  frxClass, frxDBSet,

  // Twoje jednostki
  SzczeegolyProduktuUnit, // Poprawiono literówkę (było Szczeegoly)
  FrakcjeDRS,
  UstawieniaProgramu, FireDAC.Comp.ScriptCommands, FireDAC.Stan.Util,
  FireDAC.Comp.Script;

type
  TSystemKaucyjnyForm = class(TForm)
    FDConnection1: TFDConnection;
    FDQuery1: TFDQuery;
    DataSource1: TDataSource;
    DBGrid1: TDBGrid;
    ButtonFrakcjeDRS: TButton;
    Button1: TButton;
    ButtonRaport: TButton;
    frxReport2: TfrxReport;
    frxDBItems: TfrxDBDataset;
    FDScript1: TFDScript;
    procedure FormCreate(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure Button1Click(Sender: TObject);
    procedure ButtonFrakcjeDRSClick(Sender: TObject);
    procedure ButtonRaportClick(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  SystemKaucyjnyForm: TSystemKaucyjnyForm;

implementation

{$R *.dfm}

procedure TSystemKaucyjnyForm.FormCreate(Sender: TObject);
var
  DBPath, SQLPath: string;
begin
  KeyPreview := True;

  try
    // === ŚCIEŻKA DO BAZY ===
    DBPath := TPath.Combine(ExtractFilePath(ParamStr(0)), 'system_kaucyjny.db');

    FDConnection1.Params.Clear;
    FDConnection1.Params.DriverID := 'SQLite';
    FDConnection1.Params.Database := DBPath;
    FDConnection1.LoginPrompt := False;

    FDConnection1.Connected := True;

    // === SKRYPT SQL (CREATE TABLE / INSERT) ===
    SQLPath := TPath.Combine(ExtractFilePath(ParamStr(0)), 'init.sql');

    if FileExists(SQLPath) then
    begin
      FDScript1.Connection := FDConnection1;
      FDScript1.SQLScripts.Clear;
      FDScript1.SQLScripts.Add.SQL.LoadFromFile(SQLPath);
      FDScript1.ExecuteAll;
    end
    else
      ShowMessage('Brak pliku init.sql');

    // === QUERY ===
    FDQuery1.Close;
    FDQuery1.Connection := FDConnection1;
    FDQuery1.SQL.Text := 'SELECT * FROM Produkty';
    FDQuery1.Open;

    // === DBGRID ===
    DataSource1.DataSet := FDQuery1;
    DBGrid1.DataSource := DataSource1;
    DBGrid1.Options := DBGrid1.Options + [dgRowSelect] - [dgEditing];

    FDQuery1.Last;
    FDQuery1.First;

    ShowMessage('Znaleziono rekordów: ' + IntToStr(FDQuery1.RecordCount));

  except
    on E: Exception do
      MessageDlg(
        'Błąd inicjalizacji:'#13#10 + E.Message,
        mtError, [mbOK], 0
      );
  end;
end;

procedure TSystemKaucyjnyForm.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #27 then
    Close;
end;

procedure TSystemKaucyjnyForm.ButtonRaportClick(Sender: TObject);
var
  OriginalSQL: string;
begin
  // Zapisujemy stary SQL, żeby Grid nie "zepsuł się" po zamknięciu raportu
  OriginalSQL := FDQuery1.SQL.Text;
  try
    FDQuery1.Close;
    FDQuery1.SQL.Text := 'SELECT Nazwa, Ilosc, Marza_Proc, Cena_Ew, Cena_Det FROM Produkty';
    FDQuery1.Open;

    frxDBItems.DataSet := FDQuery1;
    frxDBItems.UserName := 'Produkty';

    if frxReport2.PrepareReport then
      frxReport2.ShowReport;
  finally
    // Przywracamy poprzednie zapytanie dla DBGrid
    FDQuery1.Close;
    FDQuery1.SQL.Text := OriginalSQL;
    FDQuery1.Open;
  end;
end;

procedure TSystemKaucyjnyForm.Button1Click(Sender: TObject);
begin
  // Sprawdź czy forma istnieje w Auto-create, jeśli nie - trzeba ją stworzyć
  if Assigned(UstawieniaProgramuForm) then
    UstawieniaProgramuForm.Show
  else
    ShowMessage('Forma UstawieniaProgramu nie jest zainicjalizowana!');
end;

procedure TSystemKaucyjnyForm.ButtonFrakcjeDRSClick(Sender: TObject);
begin
  if Assigned(FrakcjeDRSForm) then
    FrakcjeDRSForm.Show;
end;

procedure TSystemKaucyjnyForm.DBGrid1DblClick(Sender: TObject);
var
  ProduktID, ProduktIlosc: Integer;
  ProduktNazwa: string;
begin
  if FDQuery1.IsEmpty then Exit;

  // FieldByName jest bezpieczniejsze niż bezpośrednie odwołania
  ProduktID := FDQuery1.FieldByName('id').AsInteger;
  ProduktNazwa := FDQuery1.FieldByName('nazwa').AsString;
  ProduktIlosc := FDQuery1.FieldByName('ilosc').AsInteger;

  // Zakładając, że ProduktForm to nazwa zmiennej w SzczegolyProduktuUnit
  // i że forma jest dodana do Auto-create forms
  if Assigned(ProduktForm) then
  begin
    ProduktForm.UstawDane(ProduktID, ProduktNazwa, ProduktIlosc);
    ProduktForm.ShowModal;

    // Odśwież listę po powrocie z edycji
    FDQuery1.Refresh;
  end
  else
    ShowMessage('Forma ProduktForm nie jest dostępna.');
end;

end.
